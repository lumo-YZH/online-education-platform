 æœåŠ¡æ‹†åˆ†ï¼ˆ8ä¸ªæ ¸å¿ƒæœåŠ¡ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                    Gateway ç½‘å…³å±‚                        â”‚â”‚         (è·¯ç”±ã€é‰´æƒã€é™æµã€æ—¥å¿—ã€è·¨åŸŸ)                    â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â†“â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                  ä¸šåŠ¡æœåŠ¡å±‚ï¼ˆ8ä¸ªæœåŠ¡ï¼‰                    â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ user-service â”‚ course-serviceâ”‚ order-serviceâ”‚ pay-serviceâ”‚â”‚  ç”¨æˆ·æœåŠ¡     â”‚   è¯¾ç¨‹æœåŠ¡    â”‚   è®¢å•æœåŠ¡    â”‚  æ”¯ä»˜æœåŠ¡   â”‚â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚ video-serviceâ”‚ search-serviceâ”‚comment-serviceâ”‚ msg-serviceâ”‚â”‚  è§†é¢‘æœåŠ¡     â”‚   æœç´¢æœåŠ¡    â”‚   è¯„è®ºæœåŠ¡    â”‚  æ¶ˆæ¯æœåŠ¡   â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â†“â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                  åŸºç¡€è®¾æ–½å±‚                              â”‚â”‚  Nacos | Sentinel | Seata | RabbitMQ | Redis | ES       â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ğŸ“¦ æ ¸å¿ƒæœåŠ¡è¯¦ç»†è®¾è®¡
1. user-serviceï¼ˆç”¨æˆ·æœåŠ¡ï¼‰
èŒè´£ï¼š ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ä¸ªäººä¿¡æ¯ç®¡ç†ã€å­¦ä¹ è®°å½•
æŠ€æœ¯äº®ç‚¹ï¼š
JWT + Redis å®ç°åˆ†å¸ƒå¼ Session
æ‰‹æœºå· + éªŒè¯ç ç™»å½•ï¼ˆé˜¿é‡Œäº‘çŸ­ä¿¡ï¼‰
ç”¨æˆ·å­¦ä¹ è¡Œä¸ºåŸ‹ç‚¹
æ•°æ®åº“è¡¨ï¼š
userï¼ˆç”¨æˆ·è¡¨ï¼‰user_profileï¼ˆç”¨æˆ·èµ„æ–™ï¼‰user_study_recordï¼ˆå­¦ä¹ è®°å½•ï¼‰user_couponï¼ˆç”¨æˆ·ä¼˜æƒ åˆ¸ï¼‰
æ ¸å¿ƒæ¥å£ï¼š
POST   /user/register          # æ³¨å†ŒPOST   /user/login             # ç™»å½•GET    /user/info              # è·å–ç”¨æˆ·ä¿¡æ¯PUT    /user/profile           # æ›´æ–°èµ„æ–™GET    /user/study-records     # å­¦ä¹ è®°å½•
2. course-serviceï¼ˆè¯¾ç¨‹æœåŠ¡ï¼‰â­æ ¸å¿ƒ
èŒè´£ï¼š è¯¾ç¨‹ç®¡ç†ã€ç« èŠ‚ç®¡ç†ã€è¯¾ç¨‹åˆ†ç±»ã€è¯¾ç¨‹è¯¦æƒ…
æŠ€æœ¯äº®ç‚¹ï¼š
Redis ç¼“å­˜çƒ­é—¨è¯¾ç¨‹ï¼ˆç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©è§£å†³æ–¹æ¡ˆï¼‰
è¯¾ç¨‹åº“å­˜ç®¡ç†ï¼ˆç§’æ€åœºæ™¯ï¼‰
å»¶è¿ŸåŒåˆ ä¿è¯ç¼“å­˜ä¸€è‡´æ€§
æ•°æ®åº“è¡¨ï¼š
courseï¼ˆè¯¾ç¨‹è¡¨ï¼‰course_chapterï¼ˆç« èŠ‚è¡¨ï¼‰course_sectionï¼ˆå°èŠ‚è¡¨ï¼‰course_categoryï¼ˆåˆ†ç±»è¡¨ï¼‰course_teacherï¼ˆè®²å¸ˆè¡¨ï¼‰
æ ¸å¿ƒæ¥å£ï¼š
GET    /course/list            # è¯¾ç¨‹åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰GET    /course/{id}            # è¯¾ç¨‹è¯¦æƒ…GET    /course/{id}/chapters   # è¯¾ç¨‹ç« èŠ‚POST   /course/seckill         # ç§’æ€æŠ¢è¯¾ â­GET    /course/hot             # çƒ­é—¨è¯¾ç¨‹ï¼ˆRedisï¼‰
ç§’æ€æŠ¢è¯¾æ ¸å¿ƒä»£ç ï¼š
@Servicepublic class SeckillService {        @Autowired    private RedisTemplate<String, Object> redisTemplate;        @Autowired    private RabbitTemplate rabbitTemplate;        /**     * ç§’æ€æŠ¢è¯¾ï¼ˆRedis + Lua è„šæœ¬ä¿è¯åŸå­æ€§ï¼‰     */    public Result seckill(Long courseId, Long userId) {        String key = "seckill:course:" + courseId;                // Lua è„šæœ¬ï¼šæ‰£å‡åº“å­˜ + é˜²æ­¢è¶…å–        String script =             "if redis.call('get', KEYS[1]) <= '0' then " +            "   return 0 " +            "else " +            "   return redis.call('decr', KEYS[1]) " +            "end";                Long stock = redisTemplate.execute(            new DefaultRedisScript<>(script, Long.class),            Collections.singletonList(key)        );                if (stock < 0) {            return Result.error("è¯¾ç¨‹å·²æŠ¢å®Œ");        }                // å‘é€ MQ å¼‚æ­¥åˆ›å»ºè®¢å•        SeckillMessage msg = new SeckillMessage(courseId, userId);        rabbitTemplate.convertAndSend("seckill.exchange", "seckill.order", msg);                return Result.success("æŠ¢è¯¾æˆåŠŸï¼Œæ­£åœ¨ç”Ÿæˆè®¢å•");    }}
3. order-serviceï¼ˆè®¢å•æœåŠ¡ï¼‰â­æ ¸å¿ƒ
èŒè´£ï¼š è®¢å•åˆ›å»ºã€è®¢å•æ”¯ä»˜ã€è®¢å•æŸ¥è¯¢ã€è®¢å•è¶…æ—¶å–æ¶ˆ
æŠ€æœ¯äº®ç‚¹ï¼š
åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSeata AT æ¨¡å¼ï¼‰
RabbitMQ å»¶è¿Ÿé˜Ÿåˆ—å®ç°è®¢å•è¶…æ—¶å–æ¶ˆ
è®¢å•çŠ¶æ€æœºè®¾è®¡
æ•°æ®åº“è¡¨ï¼š
order_infoï¼ˆè®¢å•è¡¨ï¼‰order_itemï¼ˆè®¢å•æ˜ç»†ï¼‰
æ ¸å¿ƒæ¥å£ï¼š
POST   /order/create           # åˆ›å»ºè®¢å•GET    /order/{id}             # è®¢å•è¯¦æƒ…GET    /order/my-orders        # æˆ‘çš„è®¢å•PUT    /order/{id}/cancel      # å–æ¶ˆè®¢å•
åˆ†å¸ƒå¼äº‹åŠ¡æ ¸å¿ƒä»£ç ï¼š
@Servicepublic class OrderService {        @Autowired    private CourseFeignClient courseFeignClient;        @Autowired    private UserFeignClient userFeignClient;        /**     * åˆ›å»ºè®¢å•ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰     * 1. æ‰£å‡è¯¾ç¨‹åº“å­˜ï¼ˆcourse-serviceï¼‰     * 2. æ‰£å‡ç”¨æˆ·ä½™é¢ï¼ˆuser-serviceï¼‰     * 3. åˆ›å»ºè®¢å•ï¼ˆorder-serviceï¼‰     */    @GlobalTransactional(rollbackFor = Exception.class)    public Long createOrder(OrderDTO orderDTO) {        // 1. æ‰£å‡è¯¾ç¨‹åº“å­˜        courseFeignClient.deductStock(orderDTO.getCourseId(), 1);                // 2. æ‰£å‡ç”¨æˆ·ä½™é¢        userFeignClient.deductBalance(orderDTO.getUserId(), orderDTO.getAmount());                // 3. åˆ›å»ºè®¢å•        Order order = new Order();        BeanUtils.copyProperties(orderDTO, order);        order.setStatus(OrderStatus.UNPAID);        order.setCreateTime(LocalDateTime.now());        orderMapper.insert(order);                // 4. å‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼ˆ30åˆ†é’Ÿåæ£€æŸ¥è®¢å•çŠ¶æ€ï¼‰        rabbitTemplate.convertAndSend(            "order.delay.exchange",            "order.timeout",            order.getId(),            message -> {                message.getMessageProperties().setDelay(30 * 60 * 1000);                return message;            }        );                return order.getId();    }}
è®¢å•è¶…æ—¶å–æ¶ˆï¼ˆRabbitMQ å»¶è¿Ÿé˜Ÿåˆ—ï¼‰ï¼š
@Componentpublic class OrderTimeoutListener {        @RabbitListener(queues = "order.timeout.queue")    public void handleTimeout(Long orderId) {        Order order = orderMapper.selectById(orderId);                // å¦‚æœè®¢å•è¿˜æ˜¯æœªæ”¯ä»˜çŠ¶æ€ï¼Œè‡ªåŠ¨å–æ¶ˆ        if (order.getStatus() == OrderStatus.UNPAID) {            // å–æ¶ˆè®¢å•            order.setStatus(OrderStatus.CANCELLED);            orderMapper.updateById(order);                        // æ¢å¤è¯¾ç¨‹åº“å­˜            courseFeignClient.restoreStock(order.getCourseId(), 1);        }    }}
4. video-serviceï¼ˆè§†é¢‘æœåŠ¡ï¼‰â­äº®ç‚¹
èŒè´£ï¼š è§†é¢‘ä¸Šä¼ ã€è½¬ç ã€æ’­æ”¾ã€é˜²ç›—é“¾
æŠ€æœ¯äº®ç‚¹ï¼š
MinIO å¯¹è±¡å­˜å‚¨
è§†é¢‘é˜²ç›—é“¾ï¼ˆç­¾å URLï¼‰
è§†é¢‘æ’­æ”¾è¿›åº¦è®°å½•
HLS åˆ‡ç‰‡æ’­æ”¾
æ•°æ®åº“è¡¨ï¼š
videoï¼ˆè§†é¢‘è¡¨ï¼‰video_play_recordï¼ˆæ’­æ”¾è®°å½•ï¼‰
æ ¸å¿ƒæ¥å£ï¼š
POST   /video/upload           # ä¸Šä¼ è§†é¢‘GET    /video/{id}/play-url    # è·å–æ’­æ”¾åœ°å€ï¼ˆé˜²ç›—é“¾ï¼‰POST   /video/record-progress  # è®°å½•æ’­æ”¾è¿›åº¦
é˜²ç›—é“¾å®ç°ï¼š
@Servicepublic class VideoService {        /**     * ç”Ÿæˆå¸¦ç­¾åçš„è§†é¢‘æ’­æ”¾ URLï¼ˆæœ‰æ•ˆæœŸ 1 å°æ—¶ï¼‰     */    public String getPlayUrl(Long videoId, Long userId) {        Video video = videoMapper.selectById(videoId);                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è´­ä¹°è¯¾ç¨‹        boolean hasPurchased = orderService.checkUserPurchased(userId, video.getCourseId());        if (!hasPurchased) {            throw new BusinessException("è¯·å…ˆè´­ä¹°è¯¾ç¨‹");        }                // ç”Ÿæˆç­¾å URL        String url = video.getUrl();        long expireTime = System.currentTimeMillis() + 3600 * 1000;        String sign = DigestUtils.md5Hex(url + expireTime + SECRET_KEY);                return url + "?expire=" + expireTime + "&sign=" + sign;    }}
5. search-serviceï¼ˆæœç´¢æœåŠ¡ï¼‰â­äº®ç‚¹
èŒè´£ï¼š è¯¾ç¨‹æœç´¢ã€æ™ºèƒ½æ¨èã€çƒ­æœæ¦œ
æŠ€æœ¯äº®ç‚¹ï¼š
Elasticsearch å…¨æ–‡æ£€ç´¢
æœç´¢å…³é”®è¯é«˜äº®
æœç´¢å†å²è®°å½•
çƒ­æœæ’è¡Œæ¦œï¼ˆRedis ZSetï¼‰
æ ¸å¿ƒæ¥å£ï¼š
GET    /search/course          # æœç´¢è¯¾ç¨‹GET    /search/suggest         # æœç´¢å»ºè®®GET    /search/hot             # çƒ­æœæ¦œPOST   /search/history         # ä¿å­˜æœç´¢å†å²
Elasticsearch æœç´¢å®ç°ï¼š
@Servicepublic class SearchService {        @Autowired    private ElasticsearchRestTemplate esTemplate;        /**     * æœç´¢è¯¾ç¨‹ï¼ˆæ”¯æŒåˆ†è¯ã€é«˜äº®ã€æ’åºï¼‰     */    public PageResult<CourseES> searchCourse(String keyword, Integer page, Integer size) {        // æ„å»ºæŸ¥è¯¢æ¡ä»¶        NativeSearchQuery query = new NativeSearchQueryBuilder()            .withQuery(QueryBuilders.multiMatchQuery(keyword, "name", "description", "teacher"))            .withHighlightFields(                new HighlightBuilder.Field("name").preTags("<em>").postTags("</em>")            )            .withPageable(PageRequest.of(page - 1, size))            .withSort(SortBuilders.scoreSort().order(SortOrder.DESC))            .build();                // æ‰§è¡Œæœç´¢        SearchHits<CourseES> hits = esTemplate.search(query, CourseES.class);                // å¤„ç†é«˜äº®        List<CourseES> courses = hits.stream()            .map(hit -> {                CourseES course = hit.getContent();                Map<String, List<String>> highlightFields = hit.getHighlightFields();                if (highlightFields.containsKey("name")) {                    course.setName(highlightFields.get("name").get(0));                }                return course;            })            .collect(Collectors.toList());                return new PageResult<>(courses, hits.getTotalHits());    }}
6. pay-serviceï¼ˆæ”¯ä»˜æœåŠ¡ï¼‰
èŒè´£ï¼š æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å›è°ƒã€é€€æ¬¾
æŠ€æœ¯äº®ç‚¹ï¼š
æ”¯ä»˜å®æ²™ç®±ç¯å¢ƒ
å¼‚æ­¥å›è°ƒå¤„ç†
å¹‚ç­‰æ€§ä¿è¯
æ ¸å¿ƒæ¥å£ï¼š
POST   /pay/alipay             # æ”¯ä»˜å®æ”¯ä»˜POST   /pay/callback           # æ”¯ä»˜å›è°ƒPOST   /pay/refund             # é€€æ¬¾
7. comment-serviceï¼ˆè¯„è®ºæœåŠ¡ï¼‰
èŒè´£ï¼š è¯¾ç¨‹è¯„è®ºã€ç‚¹èµã€å›å¤
æŠ€æœ¯äº®ç‚¹ï¼š
Redis ç¼“å­˜çƒ­é—¨è¯„è®º
è¯„è®ºæ ‘å½¢ç»“æ„
8. msg-serviceï¼ˆæ¶ˆæ¯æœåŠ¡ï¼‰
èŒè´£ï¼š ç«™å†…æ¶ˆæ¯ã€é‚®ä»¶é€šçŸ¥ã€çŸ­ä¿¡é€šçŸ¥
æŠ€æœ¯äº®ç‚¹ï¼š
RabbitMQ å¼‚æ­¥å‘é€
æ¶ˆæ¯æ¨¡æ¿ç®¡ç†